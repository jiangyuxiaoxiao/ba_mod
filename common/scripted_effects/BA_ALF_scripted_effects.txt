####################
##战略储备！！！
####################
##初始化战略储备效果##
ALF_initialize_livability_system_effect = {
	##将黑市的每个省份加入数组
	hidden_effect = {
		every_state = {
			limit = {
				is_core_of = A47
			}
			add_to_array = {
				array = global.black_market_state
				value = THIS.id
			}
		}
	}
	##初始化战略储备所需数值##
	ALF = {
		ALF_improve_livability_1_pts = yes
		##为TAG增加战略储备变量
		add_dynamic_modifier = {
			modifier = ALF_Livability_dynamic_modifier
		}
	}
}

##先计算宜居度导致的效果，再计算宜居度##
##计算所有宜居度相关数据
ALF_calculate_livability_effect = {
	custom_effect_tooltip = ALF_calculate_livability_state_tt
	##每个省份消耗1点战略储备##
	##获取省份数量##
	for_each_scope_loop = {
		array = global.black_market_state
		if = {
			limit = {
				is_owned_and_controlled_by = ALF
			}
			##敏感数值，需要在不断验证##
			add_to_temp_variable = {
				ALF.Livability_state_var = -0.6
			}
		}
	}
	##计算省份带来的战略储备需求##
	set_variable = {
		ALF.Livability_standard_var = ALF.Livability_state_var
	}
	##计算剩余的战略储备
	add_to_variable = {
		var = ALF.Livability_var
		value = ALF.Livability_standard_var
	}
	##计算本周期获得的战略储备##
	add_to_variable = {
		ALF.Livability_var = modifier@ALF_Livability_int
	}
	##TODO：战略储备不足造成的效果，写入动态精神中
}

##战略储备获取##
ALF_small_improve_livability_modifier_effect = {
	custom_effect_tooltip = ALF_small_improve_livability_modifier_effect_tt
	add_to_variable = {
		ALF.ALF_Livability_dynamic_modifier_var = 0.25
	}
	force_update_dynamic_modifier = yes
}

ALF_medium_improve_livability_modifier_effect = {
	custom_effect_tooltip = ALF_medium_improve_livability_modifier_effect_tt
	add_to_variable = {
		ALF.ALF_Livability_dynamic_modifier_var = 0.5
	}
	force_update_dynamic_modifier = yes
}

ALF_large_improve_livability_modifier_effect = {
	custom_effect_tooltip = ALF_large_improve_livability_modifier_effect_tt
	add_to_variable = {
		ALF.ALF_Livability_dynamic_modifier_var = 1
	}
	force_update_dynamic_modifier = yes
}

##战略储备事件消耗##
ALF_small_decrease_livability_modifier_effect = {
	custom_effect_tooltip = ALF_small_decrease_livability_modifier_effect_tt
	add_to_variable = {
		ALF.ALF_Livability_dynamic_modifier_var = -0.25
	}
	force_update_dynamic_modifier = yes
}

ALF_medium_decrease_livability_modifier_effect = {
	custom_effect_tooltip = ALF_medium_decrease_livability_modifier_effect_tt
	add_to_variable = {
		ALF.ALF_Livability_dynamic_modifier_var = -0.5
	}
	force_update_dynamic_modifier = yes
}

ALF_large_decrease_livability_modifier_effect = {
	custom_effect_tooltip = ALF_large_decrease_livability_modifier_effect_tt
	add_to_variable = {
		ALF.ALF_Livability_dynamic_modifier_var = -1
	}
	force_update_dynamic_modifier = yes
}

##战略储备效果
ALF_improve_livability_1_pts = {
	custom_effect_tooltip = ALF_improve_livability_1_pts_tt
	add_to_variable = {
		ALF.Livability_var = 1
	}
}

ALF_improve_livability_2_pts = {
	custom_effect_tooltip = ALF_improve_livability_2_pts_tt
	add_to_variable = {
		ALF.Livability_var = 2
	}
}

ALF_improve_livability_3_pts = {
	custom_effect_tooltip = ALF_improve_livability_3_pts_tt
	add_to_variable = {
		ALF.Livability_var = 3
	}
}

ALF_improve_livability_5_pts = {
	custom_effect_tooltip = ALF_improve_livability_5_pts_tt
	add_to_variable = {
		ALF.Livability_var = 5
	}
}

ALF_improve_livability_10_pts = {
	custom_effect_tooltip = ALF_improve_livability_10_pts_tt
	add_to_variable = {
		ALF.Livability_var = 10
	}
}

##消耗
ALF_use_livability_1_pts = {
	custom_effect_tooltip = ALF_use_livability_1_pts_tt
	add_to_variable = {
		ALF.Livability_var = -1
	}
}

ALF_use_livability_2_pts = {
	custom_effect_tooltip = ALF_use_livability_2_pts_tt
	add_to_variable = {
		ALF.Livability_var = -2
	}
}

ALF_use_livability_3_pts = {
	custom_effect_tooltip = ALF_use_livability_3_pts_tt
	add_to_variable = {
		ALF.Livability_var = -3
	}
}

ALF_use_livability_5_pts = {
	custom_effect_tooltip = ALF_use_livability_5_pts_tt
	add_to_variable = {
		ALF.Livability_var = -5
	}
}

ALF_use_livability_10_pts = {
	custom_effect_tooltip = ALF_use_livability_10_pts_tt
	add_to_variable = {
		ALF.Livability_var = -10
	}
}

#############
##计算军改进度
#############
ALF_initialize_military_reform_system_effect = {
	ALF = {
		set_variable = {
			ALF_mrd_progressbar_var = 0
		}
		set_variable = {
			ALF_mrd_pts = 0
		}
		##设置改革进度
		set_variable = {
			mrd_total_progress = 0
		}
		set_variable = {
			mrd_trainning_progress = 0
		}
		set_variable = {
			mrd_officer_progress = 1
		}
		set_variable = {
			mrd_modernize_progress = 0
		}
		set_variable = {
			mrd_armor_progress = 0
		}
		set_variable = {
			mrd_artillery_progress = 0
		}
		set_variable = {
			mrd_air_force_progress = 0
		}
		set_variable = {
			mrd_sf_progress = 2
		}
		force_update_dynamic_modifier = yes
	}
}

ALF_calc_military_reform_system_effect = {
	custom_effect_tooltip = ALF_calc_military_reform_system_effect_tt
	ALF = {
		##增加改革点数
		add_to_variable = {
			ALF.ALF_mrd_progressbar_var = modifier@ALF_military_reform_int
		}
		##计算是否抵达100%
		clamp_variable = {
			var = ALF_mrd_progressbar_var
			min = 0
			max = 1
		}
		if = {
			limit = {
				check_variable = {
					ALF_mrd_progressbar_var = 1
				}
			}
			ALF_gain_1_mrd_pts = yes
			set_variable = {
				ALF_mrd_progressbar_var = 0
			}
		}
		##把显示变成整数帧##
		set_variable = {
			ALF_mrd_progressbar_show_var = ALF_mrd_progressbar_var
		}
		multiply_variable = {
			ALF_mrd_progressbar_show_var = 100
		}
	}
	ALF_calc_mrd_progress_situation_effect = yes
}

ALF_calc_mrd_progress_situation_effect = {
	ALF = {
		set_variable = {
			mrd_total_progress = 0
		}
		add_to_variable = {
			mrd_total_progress = mrd_trainning_progress
		}
		add_to_variable = {
			mrd_total_progress = mrd_officer_progress
		}
		add_to_variable = {
			mrd_total_progress = mrd_modernize_progress
		}
		add_to_variable = {
			mrd_total_progress = mrd_armor_progress
		}
		add_to_variable = {
			mrd_total_progress = mrd_artillery_progress
		}
		add_to_variable = {
			mrd_total_progress = mrd_air_force_progress
		}
		add_to_variable = {
			mrd_total_progress = mrd_sf_progress
		}
	}
}

ALF_improve_military_reform_int_10 = {
	custom_effect_tooltip = ALF_improve_military_reform_int_10_tt
	add_to_variable = {
		ALF_military_reform_dynamic_modifier_var = 0.1
	}
	force_update_dynamic_modifier = yes
}

ALF_gain_1_mrd_pts = {
	ALF = {
		add_to_variable = {
			ALF_mrd_pts = 1
		}
	}
}

ALF_use_1_mrd_pts = {
	custom_effect_tooltip = ALF_use_1_mrd_pts_tt
	ALF = {
		add_to_variable = {
			ALF_mrd_pts = -1
		}
	}
}

ALF_capital_progressbargain_5_effect = {
	custom_effect_tooltip = ALF_capital_progressbargain_5_effect_tt
	ALF = {
		add_to_variable = {
			ALF_capital_progressbar_var = 5
		}
		clamp_variable = {
			var = ALF_capital_progressbar_var
			min = 0
			max = 100
		}
	}
}

##统计力量
ALF_EPW_calculate_power_score = {
	hidden_effect = {
		set_variable = {
			EPW_power_score_from_army = deployed_army_manpower_k
		}
		set_variable = {
			EPW_power_score_from_air = deployed_airforce_manpower_k
		}
		every_subject_country = {
			add_to_variable = {
				PREV.EPW_power_score_from_army = deployed_army_manpower_k
			}
			add_to_variable = {
				PREV.EPW_power_score_from_air = deployed_airforce_manpower_k
			}
		}
		multiply_variable = {
			EPW_power_score_from_army = 3
		}
		multiply_variable = {
			EPW_power_score_from_air = 2
		}
		set_variable = {
			EPW_power_score_from_factories = num_of_military_factories
		}
		multiply_variable = {
			EPW_power_score_from_factories = 2
		}
		add_to_variable = {
			EPW_power_score_from_factories = num_of_civilian_factories
		}
		set_variable = {
			EPW_power_score_from_technologies = num_researched_technologies
		}
		multiply_variable = {
			num_researched_technologies = 2
		}
		set_variable = {
			EPW_power_score = EPW_power_score_from_army
		}
		add_to_variable = {
			EPW_power_score = EPW_power_score_from_air
		}
		add_to_variable = {
			EPW_power_score = EPW_power_score_from_factories
		}
		add_to_variable = {
			EPW_power_score = EPW_power_score_from_technologies
		}
	}
}

ALF_reduce_technology_left_behind_effect = {
	if = {
		limit = {
			has_idea = ALF_technology_left_behind
		}
		swap_ideas = {
			remove_idea = ALF_technology_left_behind
			add_idea = ALF_technology_left_behind_1
		}
		set_country_flag = ALF_technology_left_behind_removed_flag
	}
	else_if = {
		limit = {
			has_idea = ALF_technology_left_behind_1
		}
		remove_ideas = ALF_technology_left_behind_1
		set_country_flag = ALF_technology_left_behind_1_removed_flag
	}
	else = {
	}
}
